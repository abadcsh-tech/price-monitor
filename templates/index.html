{% extends "base.html" %}

{% block content %}

<!-- ì¹´í…Œê³ ë¦¬ íƒ­ -->
<div class="category-tabs">
    <button class="category-tab active" data-category="all">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ ì „ì²´</button>
    <button class="category-tab" data-category="ì¡°ì„±í˜„">ğŸ‘¨ ì¡°ì„±í˜„</button>
    <button class="category-tab" data-category="ì´ì§„ê²½">ğŸ‘© ì´ì§„ê²½</button>
    <button class="category-tab" data-category="ì¡°ì˜ˆë‚˜">ğŸ‘§ ì¡°ì˜ˆë‚˜</button>
</div>

<!-- ì°¾ê³  ìˆëŠ” ì•„ì´í…œ -->
<div class="card mb-section">
    <div class="section-header">
        <h2 class="section-title">
            <span class="section-emoji">ğŸ”</span>
            ì°¾ê³  ìˆëŠ” ì•„ì´í…œ
            <span class="section-count">{{ rules|length }}ê°œ</span>
        </h2>
    </div>

    <!-- ì•„ì´í…œ ì¶”ê°€ í¼ -->
    <div class="card-body">
        <form method="post" action="{{ url_for('add_rule') }}" class="add-form">
            <div class="form-row-horizontal">
                <div class="form-field">
                    <label class="form-label">êµ¬ì„±ì›</label>
                    <select name="category" class="form-select form-select-sm">
                        {% for cat in categories %}
                        <option value="{{ cat }}">{{ cat }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-field">
                    <label class="form-label">ìœ í˜•</label>
                    <select name="rule_type" class="form-select form-select-sm">
                        <option value="brand">ğŸ·ï¸ ë¸Œëœë“œ</option>
                        <option value="keyword">ğŸ”‘ í‚¤ì›Œë“œ</option>
                    </select>
                </div>
                <div class="form-field" style="flex:1; min-width:120px;">
                    <label class="form-label">ì•„ì´í…œ</label>
                    <input type="text" name="value" class="form-control form-control-sm"
                           placeholder="ì˜ˆ: Apple, Samsung, iPhone ..." required>
                </div>
                <div class="form-field">
                    <label class="form-label">ìµœì†Œ í• ì¸ë¥ </label>
                    <div class="input-group input-group-sm" style="width:120px">
                        <input type="number" name="min_discount_percent" class="form-control"
                               value="20" min="0" max="100" step="1">
                        <span class="input-group-text">%</span>
                    </div>
                </div>
                <div class="form-field" style="align-self:flex-end;">
                    <button class="btn btn-primary btn-sm">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" class="me-1"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                        ì¶”ê°€
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- ì•„ì´í…œ í…Œì´ë¸” -->
    {% if rules %}
    <div class="table-responsive">
        <table class="table">
            <thead>
                <tr>
                    <th>êµ¬ì„±ì›</th>
                    <th>ìœ í˜•</th>
                    <th>ì•„ì´í…œ</th>
                    <th>ìµœì†Œ í• ì¸ë¥ </th>
                    <th>ìƒíƒœ</th>
                    <th>ìˆ˜ì •</th>
                </tr>
            </thead>
            <tbody id="rules-body">
            {% for rule in rules %}
                <tr class="{{ 'row-disabled' if not rule.enabled }}" data-category="{{ rule.category or 'ì¡°ì„±í˜„' }}">
                    <td>
                        <span class="pill pill-category">{{ rule.category or 'ì¡°ì„±í˜„' }}</span>
                    </td>
                    <td>
                        <span class="pill {{ 'pill-brand' if rule.rule_type == 'brand' else 'pill-keyword' }}">
                            {{ 'ğŸ·ï¸ ë¸Œëœë“œ' if rule.rule_type == 'brand' else 'ğŸ”‘ í‚¤ì›Œë“œ' }}
                        </span>
                    </td>
                    <td style="font-weight:600">{{ rule.value }}</td>
                    <td><span class="text-mono">{{ rule.min_discount_percent|int }}%</span></td>
                    <td>
                        <form method="post" action="{{ url_for('toggle_rule', rule_id=rule.id) }}" class="d-inline">
                            <button class="pill {{ 'pill-on' if rule.enabled else 'pill-off' }}" style="border:none;cursor:pointer">
                                {{ 'âœ… í™œì„±' if rule.enabled else 'â¹ï¸ ë¹„í™œì„±' }}
                            </button>
                        </form>
                    </td>
                    <td>
                        <form method="post" action="{{ url_for('delete_rule', rule_id=rule.id) }}" class="d-inline">
                            <button class="btn btn-ghost btn-icon"
                                    onclick="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')"
                                    title="ì‚­ì œ">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--danger)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
                            </button>
                        </form>
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="empty-state">
        <span class="empty-emoji">ğŸ”</span>
        <p>ë“±ë¡ëœ ì•„ì´í…œì´ ì—†ìŠµë‹ˆë‹¤.<br>ìœ„ í¼ì—ì„œ ë¸Œëœë“œ ë˜ëŠ” í‚¤ì›Œë“œë¥¼ ì¶”ê°€í•˜ì„¸ìš”.</p>
    </div>
    {% endif %}
</div>

<!-- ì•Œë¦¼ ì´ë ¥ -->
<div class="card mb-section">
    <div class="section-header">
        <h2 class="section-title">
            <span class="section-emoji">ğŸ””</span>
            ì•Œë¦¼ ì´ë ¥
            <span class="section-count">{{ history|length }}ê±´</span>
        </h2>
        <button class="btn btn-ghost btn-sm" onclick="refreshHistory()">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="me-1"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 11-2.12-9.36L23 10"/></svg>
            ìƒˆë¡œê³ ì¹¨
        </button>
    </div>

    {% if history %}
    <div class="table-responsive">
        <table class="table">
            <thead>
                <tr>
                    <th>â° ì‹œê°„</th>
                    <th>ğŸ“¦ ì œí’ˆëª…</th>
                    <th>ğŸ’° í• ì¸ê°€</th>
                    <th>ğŸ“‰ í• ì¸ìœ¨</th>
                    <th>ğŸ”— ë§í¬</th>
                </tr>
            </thead>
            <tbody id="history-body">
            {% for h in history %}
                <tr>
                    <td class="time-cell">{{ h.alerted_at }}</td>
                    <td style="font-weight:600">{{ h.product_name or '-' }}</td>
                    <td class="text-mono">{{ h.price }}</td>
                    <td>
                        {% if h.discount %}
                            <span class="discount-badge">{{ h.discount }}</span>
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>
                        {% if h.product_url and h.product_url.startswith('http') %}
                            <a href="{{ h.product_url }}" target="_blank" rel="noopener" class="product-link">ë³´ê¸° â†’</a>
                        {% else %}
                            -
                        {% endif %}
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="empty-state">
        <span class="empty-emoji">ğŸ”•</span>
        <p>ì•„ì§ ì•Œë¦¼ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.<br>ëª¨ë‹ˆí„°ë§ì„ ì‹¤í–‰í•˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
    </div>
    {% endif %}
</div>

<!-- ëª¨ë‹ˆí„°ë§ ìƒíƒœ ë°” (ë§¨ ì•„ë˜) -->
<div class="status-bar">
    <div class="status-info">
        <span class="status-emoji">{{ 'ğŸŸ¢' if monitoring else 'â¸ï¸' }}</span>
        <span class="status-dot {{ 'on' if monitoring else 'off' }}"></span>
        <div>
            <div class="status-label">
                {{ 'ëª¨ë‹ˆí„°ë§ ì‹¤í–‰ì¤‘' if monitoring else 'ëª¨ë‹ˆí„°ë§ ì¤‘ì§€ë¨' }}
            </div>
            {% if monitoring %}
            <div class="status-sub">â±ï¸ {{ interval }}ë¶„ ê°„ê²©ìœ¼ë¡œ ìë™ ìŠ¤ìº” ì¤‘</div>
            {% else %}
            <div class="status-sub">ì‹œì‘ ë²„íŠ¼ì„ ëˆŒëŸ¬ í™œì„±í™”í•˜ì„¸ìš”</div>
            {% endif %}
        </div>
    </div>
    <div class="status-buttons">
        {% if monitoring %}
        <form method="post" action="{{ url_for('monitor_stop') }}">
            <button class="btn btn-outline-danger btn-sm">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" class="me-1"><rect x="6" y="6" width="12" height="12" rx="1"/></svg>
                ì¤‘ì§€
            </button>
        </form>
        {% else %}
        <form method="post" action="{{ url_for('monitor_start') }}">
            <button class="btn btn-success btn-sm">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" class="me-1"><polygon points="6,4 20,12 6,20"/></svg>
                ì‹œì‘
            </button>
        </form>
        {% endif %}
        <form method="post" action="{{ url_for('monitor_run_now') }}">
            <button class="btn btn-primary btn-sm">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="me-1"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 11-2.12-9.36L23 10"/></svg>
                ì¦‰ì‹œ ì‹¤í–‰
            </button>
        </form>
        <button class="btn btn-ghost btn-sm" data-bs-toggle="modal" data-bs-target="#settingsModal">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-1"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
            ì„¤ì •
        </button>
    </div>
</div>

<!-- ì„¤ì • ëª¨ë‹¬ -->
<div class="modal fade" id="settingsModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form method="post" action="{{ url_for('settings_page') }}">
                <div class="modal-header">
                    <h5 class="modal-title">âš™ï¸ ì„¤ì •</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="settingsBody">
                    <div class="text-center py-3" style="color: var(--text-muted);">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-ghost" id="testTelegram">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-1"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
                        í…”ë ˆê·¸ë¨ í…ŒìŠ¤íŠ¸
                    </button>
                    <button type="button" class="btn btn-ghost" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                    <button type="submit" class="btn btn-primary">ğŸ’¾ ì €ì¥</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Category tab filtering
document.querySelectorAll('.category-tab').forEach(function(tab) {
    tab.addEventListener('click', function() {
        document.querySelectorAll('.category-tab').forEach(function(t) { t.classList.remove('active'); });
        this.classList.add('active');
        var category = this.dataset.category;
        var rows = document.querySelectorAll('#rules-body tr');
        rows.forEach(function(row) {
            if (category === 'all' || row.dataset.category === category) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    });
});

document.getElementById('settingsModal').addEventListener('show.bs.modal', function() {
    fetch('/settings')
        .then(r => r.json())
        .then(data => {
            document.getElementById('settingsBody').innerHTML = `
                <div class="mb-3">
                    <label class="form-label">ğŸ¤– Telegram Bot Token</label>
                    <input type="text" name="telegram_bot_token" class="form-control"
                           value="${data.telegram_bot_token || ''}" placeholder="123456:ABC-DEF...">
                </div>
                <div class="mb-3">
                    <label class="form-label">ğŸ’¬ Telegram Chat ID</label>
                    <input type="text" name="telegram_chat_id" class="form-control"
                           value="${data.telegram_chat_id || ''}" placeholder="123456789">
                </div>
                <div class="mb-3">
                    <label class="form-label">â±ï¸ ëª¨ë‹ˆí„°ë§ ê°„ê²© (ë¶„)</label>
                    <input type="number" name="monitoring_interval_minutes" class="form-control"
                           value="${data.monitoring_interval_minutes || '30'}" min="1">
                </div>
                <div class="mb-3">
                    <label class="form-label">ğŸŒ ëª¨ë‹ˆí„°ë§ URL</label>
                    <input type="url" name="monitoring_url" class="form-control"
                           value="${data.monitoring_url || 'https://www.toppreise.ch/new-best-prices'}">
                </div>
            `;
        });
});

document.getElementById('testTelegram').addEventListener('click', function() {
    const btn = this;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>ì „ì†¡ì¤‘...';
    fetch('/settings/test', { method: 'POST' })
        .then(r => r.json())
        .then(data => {
            alert(data.ok ? 'âœ… í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€ê°€ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤!' : 'âŒ ì „ì†¡ ì‹¤íŒ¨: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
        })
        .catch(() => alert('âŒ ìš”ì²­ ì‹¤íŒ¨'))
        .finally(() => {
            btn.disabled = false;
            btn.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-1"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>í…”ë ˆê·¸ë¨ í…ŒìŠ¤íŠ¸';
        });
});

function refreshHistory() {
    fetch('/history')
        .then(r => r.json())
        .then(data => {
            const tbody = document.getElementById('history-body');
            if (!tbody) { location.reload(); return; }
            if (!data.length) {
                tbody.innerHTML = '<tr><td colspan="5" class="empty-state"><span class="empty-emoji">ğŸ”•</span><p>ì•„ì§ ì•Œë¦¼ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</p></td></tr>';
                return;
            }
            tbody.innerHTML = data.map(h => `
                <tr>
                    <td class="time-cell">${h.alerted_at}</td>
                    <td style="font-weight:600">${h.product_name || '-'}</td>
                    <td class="text-mono">${h.price}</td>
                    <td>${h.discount ? '<span class="discount-badge">' + h.discount + '</span>' : '-'}</td>
                    <td>${h.product_url && h.product_url.startsWith('http')
                        ? '<a href="' + h.product_url + '" target="_blank" rel="noopener" class="product-link">ë³´ê¸° â†’</a>'
                        : '-'}</td>
                </tr>
            `).join('');
        });
}
</script>
{% endblock %}
